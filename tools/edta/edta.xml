<tool id="edta" name="edta" version="@WRAPPER_VERSION@+@VERSION_SUFFIX@" profile="20.01">
    <description>
        Whole-genome de-novo TE annotation 
    </description>
    <macros>
        <token name="@WRAPPER_VERSION@">2.0.0</token>
        <token name="@VERSION_SUFFIX@">galaxy0</token>
    </macros>
    <xrefs>
        <xref type="bio.tools">EDTA</xref>
    </xrefs>
    <requirements>
        <container type="docker">oushujun/edta:2.0.0</container>
    </requirements>
    <command detect_errors="exit_code"><![CDATA[
    ## Genome to TE annotations 
    #if $function_select.function == 'genome':
        ln -s '$function_select.genome' ./input.fa &&
        perl /EDTA/EDTA.pl 
        --genome input.fa
        --species '$function_select.species'
        --step '$function_select.step'
        #if $function_select.cds:
            --cds '$function_select.cds'
        #end if 
        #if $function_select.curatedlib:
            --curatedlib '$function_select.curatedlib'
        #end if
        #if $function_select.sensitive:
            --sensitive 1
        #end if
        #if $function_select.mutation_rate:
            --u "function_select.mutation_rate"
        #end if 
        #if $function_select.anno_select.anno == 'yes':
            --anno 1
            #if $function_select.anno_select.evaluate:
                --evaluate 1 
            #end if
            #if $function_select.anno_select.exclude:
                --exclude '$function_select.anno_select.exclude'
            #end if
        #end if 
    ## Find elements of a paticular TE type
    

    ## Benchmark
    #end if    
    ]]></command>
    <inputs>
        <conditional name="function_select">
            <param name="function" type="select" label="Which Function should be run">
                <option value="genome">Whole Genome</option>
                <option value="te">Specific TE</option>
                <option value="benchmark">Benchmark</option>
            </param>
            <when value="genome">
                <!-- Genome to TE annotations -->
                <param name="genome" argument="--genome" type="data" format="fasta" label="Genome File" help="The Genome FASTA file"/>
                <param name='species' argument ="--species" type="select" label="Which species should be used for identification of TIR candidates">
                    <option value="Others">Others</option>
                    <option value="Rice">Rice</option>
                    <option value="Maize">Maize</option>
                </param>
                <param name="step" argument="--step" type="select" label="Specify which steps you want to run EDTA" help="all: run the entire pipeline (default) \n filter: start from raw TEs to the end.">
                    <option value="all">All</option>
                    <option value="filter">Filter</option>
                    <option value="final">Final</option>
                    <option value="anno">Anno</option>
                </param>
                <param name="cds" argumet="--cds" type="data" format="fasta" label="Coding Sequence File" optional='true' help="Provide a FASTA file containing the coding sequence (no introns, UTRs, nor TEs) of this genome or its close relative."/> 
                <param name="curatedlib" argument="--curatedlib" type="data" format="fasta" label="Curated Library File" optional='true' help="Provided a curated library to keep consistant naming and classification for known TEs. All TEs in this file will be trusted 100%, so please ONLY provide MANUALLY CURATED ones here."/>
                <param name="sensitive" argument="--sensitive" type="boolean"  truevalue="1" falsevalue="0"  label="Use RepeatModeler to identify remaining TEs" help="Use RepeatModeler to identify remaining TEs This step is very slow and MAY help to recover some TEs."/>
                <param name="mutation_rate" argument="--u" type="float" optional="True" label="Neutral Mutation Rate" help="Neutral mutation rate to calculate the age of intact LTR elements. Default: 1.3e-8 (per bp per year, from rice)"></param>
                <conditional name='anno_select'>
                    <param name="anno" type="select" label="Would you like to perform whole-genome TE annotation after TE library construction?">
                        <option value="yes">Yes</option>
                        <option value="no">No</option>
                    </param>
                    <when value="yes">
                        <param name="evaluate" argument="--evaluate" type="boolean" truevalue="1" falsevalue="0" label="evaluate" help="Evaluate (1) classification consistency of the TE annotation " />
                        <param name="exclude" argument="--exclude" type="data" format="bed" label="Exclude" help="Exclude bed format regions from TE annotation" optional="true"/>
                    </when>
                </conditional>

            </when>
            <!-- Find elements of a paticular TE type -->
            <when value="te">
                <param name="genome" argument="--genome" type="data" format="fasta" label="Genome File" help="The Genome FASTA file"/>
                <param name='species' argument ="--species" type="select" label="Which species should be used for identification of TIR candidates">
                    <option value="Others">Others</option>
                    <option value="Rice">Rice</option>
                    <option value="Maize">Maize</option>
                </param>
                <param name="type" argument="--type" type="select" label="Which type of raw TE candidates do you want?">
                    <option value="all">all</option>
                    <option value="ltr">ltr</option>
                    <option value="tir">tir</option>
                    <option value="helitron">helitron</option>
                </param>
            </when>
            <!-- Benchmark -->
            <when value="benchmark">
                <conditional name="benchmark_step">
                    <param name="benchmark_select" type="select" label="Do you want to annotate a genome with your new method or test against EDTA?">
                        <option value="annotate_genome">Annotate Genome</option>
                        <option value="benchmark_genome">Benchmark Against EDTA</option>
                    </param>
                    <when value="annotate_genome">
                        <param name="custom_library" type="data" format="fasta"></param>
                        <param name="annotate_library" type="data" format="fasta"></param>
                    </when>
                    <when value="benchmark_genome">
                        <param name="genome" argument="-genome" type="data" format="fasta" label="Genome File" help="The Genome FASTA file"/>
                        <param name="std" argument="-std" type="data" format="fasta" label="Out file of standard Library" help="RepeatMasker .out file of the standard library"></param>
                        <param name="tst" argument="-tst" type="data" format="fasta" label="Out file of test library" help="RepeatMasker .out file of the test library"></param>
                        <param name="cat" argument="-cat" type="select" label="Which TE category would you like to test?">
                            <option value="Total">Total</option>
                            <option value="LTR">LTR</option>
                            <option value="nonLTR">nonLTR</option>
                            <option value="LINE">LINE</option>
                            <option value="SINE">SINE</option>
                            <option value="TIR">TIR</option>
                            <option value="MITE">MITE</option>
                            <option value="Helitron">Helitron</option>
                        </param>
                        <param name="n" argument="-n" type="select" label="Would you like to include N's in the total length of the genome? Default is to not inclue N's">
                            <option value="0">No</option>
                            <option value="1">Yes</option>
                        </param>
                    </when>
                </conditional>
            </when>
        </conditional>


    </inputs>
    <outputs>
        <!--  Genome to TE Annotations-->
        <data name="outfile_library" from_work_dir="*.mod.EDTA.TElib.fa" format="fasta"  label="${tool.name} on ${on_string}: Non-Redundant TE Library">
            <filter>function_select['function'] == "genome"</filter>
        </data>
        <data name="Novel_TE_Families"  from_work_dir="*.mod.EDTA.TElib.novel.fa" format="fasta" label="${tool.name} on ${on_string}: Novel TE Families">
            <filter>function_select['function'] == "genome" and function_select['curatedlib']</filter>
        </data>
        <data name="Whole_Genome_TE_Annotation" from_work_dir="*.mod.EDTA.TEanno.gff3" format="gff3" label="${tool.name} on ${on_string}: Whole Genome TE Annotation">
            <filter>function_select['function'] == "genome" and  function_select['anno_select']['anno'] == "yes" </filter>
        </data>
        <data name="Summary_Whole_Genome_TE_Annotation" from_work_dir="*.mod.EDTA.TEanno.sum" format="sum" label="${tool.name} on ${on_string}: Summary of Whole Genome TE Annotation">
            <filter>function_select['function'] == "genome" and  function_select['anno_select']['anno'] == "yes"</filter>
        </data>
        <data name="Low_Threshold_TE_Masking" from_work_dir="*.mod.MAKER.masked" format="gff3" label="${tool.name} on ${on_string}: Low_Threshold_TE_Masking">
            <filter>function_select['function'] == "genome" and  function_select['anno_select']['anno'] == "yes"</filter>
        </data>
        <data name="Annotation_Inconsistency_Simple_TEs" from_work_dir="*.mod.EDTA.TE.fa.stat.redun.sum" format="sum" label="${tool.name} on ${on_string}: Simple TE Annotation Inconsistency">
            <filter> function_select['function'] == "genome" and  function_select['anno_select']['anno'] == "yes" and function_select['anno_select']['evaluate'] is True </filter>
        </data>
        <data name="Annotation_Inconsistency_Nested_TEs" from_work_dir="*.mod.EDTA.TE.fa.stat.nested.sum" format="sum" label="${tool.name} on ${on_string}: Nested TE Annotation Inconsistency">
            <filter> function_select['function'] == "genome" and  function_select['anno_select']['anno'] == "yes" and function_select['anno_select']['evaluate'] is True </filter>
        </data>
        <data name="Overall_Annotation_Inconsistency" from_work_dir="*.mod.EDTA.TE.fa.stat.all.sum" format="sum" label="${tool.name} on ${on_string}: Overall Annotation Inconsistency">
            <filter> function_select['function'] == "genome" and  function_select['anno_select']['anno'] == "yes" and function_select['anno_select']['evaluate'] is True</filter>
        </data>
        <!-- Find elements of a paticular TE type -->

        <!-- Benchmark -->

    </outputs>
    <tests>
         <!--  Genome to TE Annotations-->
        <!-- Find elements of a paticular TE type -->
        <!-- Benchmark -->
    </tests>
    <citations>
        <citation type="doi">10.1186/s13059-019-1905-y</citation>
    </citations>
    <help><![CDATA[
        
**The Extensive *de novo* TE Annotator (EDTA)**
-----------------------------------------------
        

This package is developed for automated whole-genome de-novo TE annotation and benchmarking the annotation performance of TE libraries.

The EDTA package was designed to filter out false discoveries in raw TE candidates and generate a high-quality non-redundant TE library for whole-genome TE annotations. Selection of initial search programs were based on benckmarkings on the annotation performance using a manually curated TE library in the rice genome.
        

**Inputs**
----------

**Required**

The genome file [FASTA]. Please make sure sequence names are short (<=13 characters) and simple (i.e, letters, numbers, and underscore).

**Optional**

1. Coding sequence of the species or a closely related species [FASTA]. This file helps to purge gene sequences in the TE library.
2. Known gene positions of this version of the genome assembly [BED]. Coordinates specified in this file will be excluded from TE annotation to avoid over-masking.
3. Curated TE library of the species [FASTA]. This file is trusted 100%. Please make sure it's curated. If you only have a couple of curated sequences, that's fine. It doesn't need to be complete. Providing curated TE sequences, especially for those under annotated TE types (i.e., SINEs and LINEs), will greatly improve the annotation quality.

**Outputs**
-----------

A non-redundant TE library. The curated library will be included in this file if provided. TEs are classified into the superfamily level and using the three-letter naming system reported in Wicker et al. (2007).(https://www.nature.com/articles/nrg2165). Each sequence can be considered as a TE family.

**Optional**

1. Novel TE families: This file contains TE sequences that are not included in the curated library (`curatedlib` required).
2. Whole-genome TE annotation: This file contains both structurally intact and fragmented TE annotations (`anno` required).
3. Summary of whole-genome TE annotation: (`anno` required).
4. Low-threshold TE masking: This is a genome file with only long TEs (>=1 kb) being masked. You may use this for de novo gene annotations. In practice, this approach will reduce overmasking for genic regions, which can improve gene prediction quality. However, initial gene models should contain TEs and need further filtering (`anno` required).
5. Annotation inconsistency for simple TEs: (`anno and evaluate` required).
6. Annotation inconsistency for nested TEs: (`anno and evaluate` required).
7. Overall annotation inconsistency: (`anno and evaluate` required).




]]></help>
</tool>